<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    html, body { height: 100%; margin: 0; padding: 0; background: #f4f7f6; }
    body { font-family: 'Apple SD Gothic Neo', sans-serif; display: flex; flex-direction: column; overflow: hidden; }
    .header { padding: 15px; background: white; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.1rem; text-align: center; flex-shrink: 0; }
    .content { flex: 1; overflow-y: auto; padding: 12px 12px 80px 12px; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
    .card { background: white; padding: 12px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    #timer { font-size: 3rem; font-weight: bold; margin: 5px 0; color: #333; text-align: center; font-variant-numeric: tabular-nums; }
    .rating { display: flex; justify-content: center; flex-direction: row-reverse; gap: 8px; margin: 5px 0; }
    .rating input { display: none; }
    .rating label { font-size: 2rem; color: #ddd; cursor: pointer; }
    .rating input:checked ~ label { color: #f1c40f; }
    button { padding: 14px; font-size: 1rem; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin: 4px 0; transition: 0.2s; }
    .btn-blue { background: #3498db; color: white; }
    .btn-green { background: #2ecc71; color: white; }
    .btn-red { background: #e74c3c; color: white; }
    .btn-purple { background: #9b59b6; color: white; }
    .btn-gray { background: #95a5a6; color: white; }
    input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
    .label { text-align: left; font-size: 0.8rem; color: #666; font-weight: bold; margin-top: 5px; }
    #history-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; z-index: 100; overflow-y: auto; padding: 15px 15px 100px 15px; box-sizing: border-box; }
    .morning-status-card { background: #e8f4fd; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #3498db; text-align: center; }
    .history-card { background: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; text-align: left; border-left: 5px solid #3498db; font-size: 0.85rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<div class="header">ğŸ”ï¸ SAT PEAK ì›ì • í›ˆë ¨ ì¼ì§€</div>

<div class="content">
  <div id="morning-box" class="card" style="background: #e8f4fd; display: none;">
    <div class="label">â˜€ï¸ ê¸°ìƒ í›„ ì»¨ë””ì…˜ ì²´í¬</div>
    <div class="rating">
      <input type="radio" name="star" id="star5" value="5"><label for="star5">â˜…</label>
      <input type="radio" name="star" id="star4" value="4"><label for="star4">â˜…</label>
      <input type="radio" name="star" id="star3" value="3" checked><label for="star3">â˜…</label>
      <input type="radio" name="star" id="star2" value="2"><label for="star2">â˜…</label>
      <input type="radio" name="star" id="star1" value="1"><label for="star1">â˜…</label>
    </div>
    <div id="condition-text" style="font-size: 0.8rem; color: #666; margin-bottom: 8px; text-align: center;">ë³´í†µ (ì •ìƒí›ˆë ¨)</div>
    <button id="btn-morning" class="btn-blue" onclick="saveMorning()">ì»¨ë””ì…˜ ì €ì¥ ë° ì˜¤ëŠ˜ ìˆ¨ê¸°ê¸°</button>
  </div>

  <div class="card">
    <select id="type">
      <option value="ê³„ë‹¨">ğŸƒ ê³„ë‹¨ ì˜¤ë¥´ë‚´ë¦¬ê¸°</option>
      <option value="ì¤‘ëŸ‰í•˜ì´í‚¹">ğŸ’ ì¤‘ëŸ‰ í•˜ì´í‚¹</option>
      <option value="í„±ê±¸ì´">ğŸ’ª í„±ê±¸ì´</option>
      <option value="ë°”ì¼íœ˜ë‘ë¥´ê¸°">â›ï¸ ë°”ì¼ íœ˜ë‘ë¥´ê¸°</option>
      <option value="ìŠ¤ì¿¼íŠ¸">ğŸ‹ï¸ ìŠ¤ì¿¼íŠ¸</option>
      <option value="ëŸ¬ë‹">ğŸ‘Ÿ ëŸ¬ë‹</option>
      <option value="ë“±ë°˜">ğŸ§— ë“±ë°˜ í›ˆë ¨</option>
    </select>
    <div id="timer">00:00:00</div>
    <div style="display: flex; gap: 8px;">
      <button class="btn-green" style="width:50%" onclick="startTimer()">ì‹œì‘</button>
      <button class="btn-red" style="width:50%" onclick="stopTimer()">ì¤‘ì§€</button>
    </div>
  </div>

  <div class="card">
    <div id="dynamic-label" class="label">íšŒì°¨ / ì‹¬ë°• / ì¤‘ëŸ‰(kg)</div>
    <div style="display: flex; gap: 5px;">
      <input type="number" id="lapOrDist" placeholder="íšŒì°¨" value="1">
      <input type="number" id="hr" placeholder="ì‹¬ë°•">
      <input type="number" id="weight" placeholder="kg">
    </div>
    <input type="text" id="pace" placeholder="ì¥ì†Œ/í˜ì´ìŠ¤" style="display:none;">
    <textarea id="memo" placeholder="í›ˆë ¨ ë©”ëª¨ (ë°°ë‚­ ë¬´ê²Œ, ì»¨ë””ì…˜ ë“±)"></textarea>
    <button id="btn-session" class="btn-blue" onclick="saveSession()">ì„¸íŠ¸ ê¸°ë¡í•˜ê¸°</button>
    <button class="btn-gray" onclick="resetTimer()">íƒ€ì´ë¨¸ ë¦¬ì…‹</button>
  </div>

  <button class="btn-purple" onclick="openHistory()">ğŸ” ê³¼ê±° ê¸°ë¡ ì¡°íšŒí•˜ê¸°</button>
</div>

<div id="history-layer">
  <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="margin:0;">ê¸°ë¡ ì¡°íšŒ</h3>
    <button onclick="closeHistory()" style="width:60px; padding:8px; background:#ddd; border-radius: 8px; font-size:0.8rem;">ë‹«ê¸°</button>
  </div>
  <input type="date" id="search-date">
  <button id="btn-load" class="btn-purple" onclick="loadHistory()">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <div id="morning-status-display" style="margin-top:15px;"></div>
  <div id="history-display"></div>
</div>

<script>
  // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
  const API_URL = "https://script.google.com/macros/s/AKfycbynBT6T98e5dUDCRyQ1UBAO9LozhxklCoqSKufC6ig0wDRLwdnHTVY6gxBlOYwBxnV-qA/exec";
  let startTime, timerInterval, elapsedTime = 0;

  function getDDay() {
    const target = new Date("2026-04-11");
    const today = new Date();
    const diff = target - today;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  }

 // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ì»¨ë””ì…˜ ì²´í¬ ì—¬ë¶€ í™•ì¸
window.onload = function() {
  const lastCheckDate = localStorage.getItem('lastConditionCheck');
  // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ìƒì„± (yyyy-MM-dd)
  const today = new Date().toLocaleDateString('sv-SE'); 
  
  if (lastCheckDate === today) {
    document.getElementById('morning-box').style.display = 'none';
  } else {
    document.getElementById('morning-box').style.display = 'block';
  }
};

  // AI í”¼ë“œë°± ìƒì„± í•¨ìˆ˜ (ë…ë¦½ ì„ ì–¸)
  function generateAIFeedback(grouped, dday) {
    let feedback = `<div style="padding:12px; background:#fff9db; border-radius:10px; border:1px solid #f1c40f; margin-bottom:15px; font-size:0.85rem; line-height:1.5;">`;
    feedback += `<strong>ğŸ¤– SAT PEAK ì›ì • AI ë¦¬í¬íŠ¸ (D-${dday})</strong><br><hr style="border:0; border-top:1px solid #e5c100; margin:8px 0;">`;

    if (grouped["ê³„ë‹¨"] || grouped["ì¤‘ëŸ‰í•˜ì´í‚¹"]) {
      const stairData = grouped["ê³„ë‹¨"] || grouped["ì¤‘ëŸ‰í•˜ì´í‚¹"];
      const hrValues = stairData.map(r => parseInt(r.hr)).filter(v => v > 0);
      const maxHr = hrValues.length > 0 ? Math.max(...hrValues) : 0;
      const weight = parseInt(stairData[0].weight) || 0;

      if (maxHr >= 165) {
        feedback += `ğŸš© **ê°•ë„ ì•Œë¦¼:** ì‹¬ë°•ìˆ˜(${maxHr}bpm)ê°€ ë†’ìŠµë‹ˆë‹¤. ìƒì²˜ ë¶€ìœ„ ì•ˆì •ê¸°ì¸ ë§Œí¼ Zone 3 ìœ ì§€ì— ì§‘ì¤‘í•˜ì„¸ìš”.<br>`;
      } else {
        feedback += `âœ… **ì•ˆì •ì„±:** ì ì ˆí•œ ê°•ë„ ë°°ë¶„ì…ë‹ˆë‹¤. ì‹¬í íš¨ìœ¨ì´ ê°œì„ ë˜ê³  ìˆìŠµë‹ˆë‹¤.<br>`;
      }

      if (weight >= 12) {
        feedback += `ğŸ’ **í•˜ì¤‘:** 12kg ì ì‘ë ¥ì´ ì¢‹ìŠµë‹ˆë‹¤. ì›ì • ë°°ë‚­ ë¬´ê²Œë¥¼ ê³ ë ¤í•´ 1~2kgì”© ì ì§„ì  ì¦ëŸ‰ì„ ì¶”ì²œí•©ë‹ˆë‹¤.<br>`;
      }
      feedback += `ğŸ“ˆ **ì¤€ë¹„ë„:** í˜„ì¬ í˜ì´ìŠ¤ ìœ ì§€ ì‹œ ë“±ì • ì„±ê³µ í™•ë¥  **88%** ì˜ˆìƒ`;
    } else {
      feedback += `ğŸ“ ì˜¤ëŠ˜ì€ ì›ì • ë“±ë°˜ì— í•„ìš”í•œ 'í„±ê±¸ì´' ë“± ê·¼ë ¥ ê°•í™” ë˜ëŠ” ê¸°ìˆ  ìˆ™ë ¨ì— ì§‘ì¤‘í•œ ë‚ ì´êµ°ìš”.`;
    }
    feedback += `</div>`;
    return feedback;
  }

  // ì €ì¥ ë° íƒ€ì´ë¨¸ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼ (ìƒëµ ì—†ì´ í¬í•¨ë¨)
  document.querySelectorAll('.rating input').forEach(input => {
    input.addEventListener('change', (e) => {
      const texts = { "1": "ë§¤ìš° ë‚˜ì¨", "2": "í”¼ë¡œí•¨", "3": "ë³´í†µ", "4": "ì¢‹ìŒ", "5": "ìµœìƒ" };
      document.getElementById('condition-text').innerText = texts[e.target.value] + " (ì •ìƒí›ˆë ¨)";
    });
  });

  document.getElementById('type').addEventListener('change', function() {
    const type = this.value;
    const label = document.getElementById('dynamic-label');
    const paceInput = document.getElementById('pace');
    const weightInput = document.getElementById('weight');
    const lapInput = document.getElementById('lapOrDist');
    lapInput.type = "number"; paceInput.style.display = 'none'; weightInput.style.display = 'block';
    if (type === 'ê³„ë‹¨') { label.innerText = "íšŒì°¨ / ìµœëŒ€ì‹¬ë°•ìˆ˜ / ì¤‘ëŸ‰(kg)"; lapInput.placeholder = "íšŒì°¨"; }
    else if (type === 'ì¤‘ëŸ‰í•˜ì´í‚¹') { label.innerText = "ê±°ë¦¬(km) / ìµœëŒ€ì‹¬ë°•ìˆ˜ / ì¤‘ëŸ‰(kg)"; lapInput.placeholder = "km"; }
    else if (type === 'í„±ê±¸ì´' || type === 'ìŠ¤ì¿¼íŠ¸' || type === 'ë°”ì¼íœ˜ë‘ë¥´ê¸°') { label.innerText = "íšŸìˆ˜ / ìµœëŒ€ì‹¬ë°•ìˆ˜ / ì¶”ê°€ì¤‘ëŸ‰(kg)"; lapInput.placeholder = "íšŸìˆ˜"; }
    else if (type === 'ëŸ¬ë‹') { label.innerText = "ê±°ë¦¬(km) / ìµœëŒ€ì‹¬ë°•ìˆ˜"; lapInput.placeholder = "km"; paceInput.style.display = 'block'; weightInput.style.display = 'none'; }
    else if (type === 'ë“±ë°˜') { label.innerText = "ë‚´ìš© / ìµœëŒ€ì‹¬ë°• / ê¸°ì˜¨(â„ƒ)"; lapInput.type = "text"; paceInput.style.display = 'block'; }
  });

  function openHistory() { document.getElementById('history-layer').style.display = 'block'; }
  function closeHistory() { document.getElementById('history-layer').style.display = 'none'; }
  function resetTimer() { stopTimer(); elapsedTime = 0; document.getElementById("timer").innerText = "00:00:00"; }

  // 2. ì»¨ë””ì…˜ ì €ì¥ í•¨ìˆ˜ (UI ì¦‰ì‹œ ìˆ¨ê¹€ ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê¸°ë¡)
async function saveMorning() {
  const star = document.querySelector('input[name="star"]:checked').value;
  const text = document.getElementById('condition-text').innerText;
  const today = new Date().toLocaleDateString('sv-SE');
  const btn = document.getElementById('btn-morning');
  
  btn.disabled = true;
  btn.innerText = "ì €ì¥ ì¤‘...";

  try {
    // ë°±ì—”ë“œ Hì—´(condition)ì— ê¸°ë¡ë˜ë„ë¡ ì „ì†¡
    await fetch(API_URL, { 
      method: "POST", 
      mode: "no-cors", 
      body: JSON.stringify({ 
        type: "ì•„ì¹¨ì»¨ë””ì…˜", 
        condition: star + "ì  (" + text + ")" 
      })
    });
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë¡ (ìƒˆë¡œê³ ì¹¨ ë°©ì–´)
    localStorage.setItem('lastConditionCheck', today);
    
    // UI ì¦‰ì‹œ ìˆ¨ê¹€
    document.getElementById('morning-box').style.display = 'none';
    alert("ì˜¤ëŠ˜ ì»¨ë””ì…˜ ì €ì¥ ì™„ë£Œ! ì›ì • ì¤€ë¹„ í™”ì´íŒ…ì…ë‹ˆë‹¤.");
  } catch (e) { 
    alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message); 
    btn.disabled = false;
    btn.innerText = "ì»¨ë””ì…˜ ì €ì¥";
  }
}

  async function saveSession() {
    const type = document.getElementById('type').value;
    const lapInput = document.getElementById('lapOrDist');
    const hrInput = document.getElementById('hr');
    const weightInput = document.getElementById('weight');
    const btn = document.getElementById('btn-session');
    const data = { type: type, time: document.getElementById('timer').innerText, lapOrDist: lapInput.value, hr: hrInput.value, weight: weightInput.value || "-", pace: document.getElementById('pace').value || "-", memo: document.getElementById('memo').value };
    btn.disabled = true;
    try {
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data)});
      alert("ê¸°ë¡ ì™„ë£Œ!");
      resetTimer(); hrInput.value = "";
      if (type === "ê³„ë‹¨") lapInput.value = parseInt(lapInput.value) + 1;
      else { lapInput.value = "1"; weightInput.value = ""; }
    } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); } finally { btn.disabled = false; }
  }

  // ğŸš€ í•µì‹¬ ìˆ˜ì •ëœ loadHistory
async function loadHistory() {
  const dateInput = document.getElementById('search-date').value;
  if(!dateInput) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  
  const morningDisplay = document.getElementById('morning-status-display');
  const historyDisplay = document.getElementById('history-display');
  const copyBtn = document.getElementById('btn-copy');
  
  morningDisplay.innerHTML = "";
  historyDisplay.innerText = "ë°ì´í„° ë¶„ì„ ì¤‘...";
  if(copyBtn) copyBtn.style.display = 'none';

  try {
    const resp = await fetch(`${API_URL}?date=${dateInput}`);
    const records = await resp.json();
    historyDisplay.innerHTML = "";

    if(!records || records.length === 0) {
      historyDisplay.innerText = "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const dday = getDDay();
    // ë°ì´í„° ê·¸ë£¹í™” ë° ì•„ì¹¨ ì»¨ë””ì…˜(Hì—´) ì¶”ì¶œ ë¡œì§
    const grouped = records.reduce((acc, curr) => {
      if (curr.type === "ì•„ì¹¨ì»¨ë””ì…˜") {
        // Hì—´(condition) ë°ì´í„°ë¥¼ ìš°ì„  ì°¸ì¡°í•˜ê³  ì—†ì„ ê²½ìš° ë©”ëª¨ ì°¸ì¡°
        acc.morning = curr.condition || curr.review || curr.memo || "ê¸°ë¡ ì—†ìŒ";
        morningDisplay.innerHTML = `<div class="morning-status-card"><strong>â˜€ï¸ ê¸°ìƒ ì»¨ë””ì…˜</strong><br>${acc.morning}</div>`;
      } else {
        if (!acc[curr.type]) acc[curr.type] = [];
        acc[curr.type].push(curr);
      }
      return acc;
    }, { morning: "ê¸°ë¡ ì—†ìŒ" });

    // AI í”¼ë“œë°± ì¶œë ¥ (ë‚ ì§œ ë³´ì • í¬í•¨)
    historyDisplay.innerHTML = generateAIFeedback(grouped, dday);
    if(copyBtn) copyBtn.style.display = 'block';

    // ì¢…ëª©ë³„ ì¹´ë“œ ì¶œë ¥
    for (const type in grouped) {
      if (type === "morning") continue;
      const card = document.createElement('div');
      card.className = 'history-card';
      
      let detailHtml = `<strong>[${type}]</strong><hr style="border:0; border-top:1px solid #eee; margin:5px 0;">`;
      
      grouped[type].forEach((r, idx) => {
        const hrText = r.hr ? ` | ğŸ’“${r.hr}bpm` : "";
        const weightText = (r.weight && r.weight !== "-") ? ` | ğŸ’${r.weight}kg` : "";
        const timeText = r.time ? ` | â±ï¸${r.time}` : "";
        
        detailHtml += `
          <div style="margin-bottom:8px; padding-bottom:5px; ${idx < grouped[type].length - 1 ? 'border-bottom:1px dashed #eee;' : ''}">
            <span style="color:#3498db; font-weight:bold;">${idx + 1}ì°¨ :</span> ${r.lapOrDist || "0"}${type === 'ê³„ë‹¨' ? 'íšŒ' : ''} 
            ${timeText}${hrText}${weightText}
            ${r.memo ? `<br><small style="color:#888;">ã„´ ${r.memo}</small>` : ''}
          </div>`;
      });
      card.innerHTML = detailHtml;
      historyDisplay.appendChild(card);
    }

    // ì¹´í†¡ ê³µìœ ìš© í…ìŠ¤íŠ¸ ìƒì„± (ë‚ ì§œ ë³´ì •)
    currentSummaryText = `ğŸ”ï¸ SAT PEAK í›ˆë ¨ ìš”ì•½ (${dateInput})\nğŸ“… ì›ì • D-${dday}\nâ˜€ï¸ ì»¨ë””ì…˜: ${grouped.morning}\n\n`;
    for (const type in grouped) {
      if (type === "morning") continue;
      currentSummaryText += `[${type}]\n`;
      grouped[type].forEach((r, idx) => {
        currentSummaryText += `${idx + 1}ì°¨: ${r.lapOrDist || "0"}${type==='ê³„ë‹¨'?'íšŒ':''}\n`;
      });
      currentSummaryText += `\n`;
    }
    currentSummaryText += `ğŸ¤– AI ì½”ì¹˜: ë“±ì • í™•ë¥  88% ì˜ˆìƒ.`;

  } catch (e) {
    historyDisplay.innerText = "ì¡°íšŒ ì‹¤íŒ¨: " + e.message;
  }
}

  function startTimer() { if (!timerInterval) { startTime = Date.now() - elapsedTime; timerInterval = setInterval(updateTime, 100); } }
  function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
  function updateTime() { elapsedTime = Date.now() - startTime; let s = Math.floor(elapsedTime / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60); document.getElementById("timer").innerText = (h>0?h+":":"")+(m%60<10?"0"+m%60:m%60)+":"+(s%60<10?"0"+s%60:s%60); }
</script>
</body>
</html>


